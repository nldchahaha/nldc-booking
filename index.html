<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†±èˆç¤¾æˆç™¼é è³¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .seat { width: 30px; height: 30px; margin: 2px; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .available { background-color: #f3f4f6; border: 1px solid #d1d5db; }
        .selected { background-color: #ff69b4; color: white; }
        .occupied { background-color: #9ca3af; color: white; cursor: not-allowed; opacity: 0.6; }
        .bg-pink-main { background-color: #ffc0cb; }
    </style>
</head>
<body class="bg-white text-gray-800 pb-24">

    <header class="py-8 text-center bg-pink-50">
        <h1 class="text-3xl font-extrabold text-pink-500">æˆç™¼é è³¼åŠƒä½ç³»çµ±</h1>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-8">
        <section class="space-y-3">
            <h2 class="font-bold border-l-4 border-pink-300 pl-2">1. åŸºæœ¬è³‡æ–™</h2>
            <input id="name" type="text" placeholder="å§“å" class="w-full border p-3 rounded-xl">
            <input id="class_name" type="text" placeholder="ç­ç´š (å¦‚: 206)" class="w-full border p-3 rounded-xl">
        </section>

        <section class="space-y-4">
            <h2 class="font-bold border-l-4 border-pink-300 pl-2">2. é¸æ“‡é …ç›® (å·²è¨­å®šå®šåƒ¹)</h2>
            <div class="p-4 border rounded-2xl flex justify-between items-center">
                <div><p class="font-bold">é è³¼é–€ç¥¨ <span class="text-pink-500 ml-2">$150</span></p></div>
                <input id="ticket_qty" type="number" value="0" min="0" onchange="updateUI()" class="w-16 text-center border-b">
            </div>
            <div class="p-4 border rounded-2xl flex justify-between items-center bg-pink-50">
                <div><p class="font-bold">çµ„åˆæ–¹æ¡ˆ (ç¥¨+T-shirt) <span class="text-pink-500 ml-2">$450</span></p></div>
                <input id="bundle_qty" type="number" value="0" min="0" onchange="updateUI()" class="w-12 text-center border-b bg-transparent">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="p-3 border rounded-xl">
                    <p class="text-sm font-bold">T-shirt A ($350)</p>
                    <input id="tshirt_qty" type="number" value="0" min="0" onchange="updateUI()" class="w-full mt-1 text-center border-t">
                </div>
                <div class="p-3 border rounded-xl">
                    <p class="text-sm font-bold">å¤–å¥— ($800)</p>
                    <input id="jacket_qty" type="number" value="0" min="0" onchange="updateUI()" class="w-full mt-1 text-center border-t">
                </div>
            </div>
        </section>

        <section>
            <h2 class="font-bold border-l-4 border-pink-300 pl-2 mb-2">3. æŒ‘é¸åº§ä½</h2>
            <p id="seat-hint" class="text-xs text-gray-500 mb-4">è«‹å…ˆè³¼ç¥¨ä»¥ç²å¾—åŠƒä½è³‡æ ¼</p>
            <div class="border rounded-2xl p-4 bg-gray-50 overflow-x-auto">
                <div class="w-[400px] mx-auto">
                    <div class="bg-pink-200 text-white text-center py-1 rounded mb-6 italic">STAGE èˆå°</div>
                    <div id="seat-container" class="grid grid-cols-10 gap-1"></div>
                </div>
            </div>
        </section>

        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 flex items-center justify-between shadow-2xl">
            <div>
                <p class="text-xs text-gray-400">æ‡‰ä»˜ç¸½é¡ (äº¤çµ¦206æ—ä½‘å®¶)</p>
                <p class="text-xl font-bold text-pink-500">$ <span id="total-display">0</span></p>
            </div>
            <button onclick="submitOrder()" class="bg-pink-main text-white px-8 py-3 rounded-full font-bold shadow-lg">ç¢ºèªé€å‡º</button>
        </div>
    </main>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby-IhhfuYyrAGJG25Q-zIvgOSsTL8p3LShjxidhPdAF24WL9m-PjihVVswQAmZvt6Uz/exec';
        const PRICES = { ticket: 150, bundle: 450, tshirt: 350, jacket: 800 };
        let selectedSeats = [];
        let occupiedSeats = []; // å¾å¾Œå°è®€å–çš„å·²ä½”ç”¨åº§ä½

        // åˆå§‹åŒ–åº§ä½èˆ‡è®€å–å¾Œå°è³‡æ–™
        window.onload = async function() {
            // ç”¢ç”Ÿ 80 å€‹åº§ä½
            const container = document.getElementById('seat-container');
            for (let i = 1; i <= 80; i++) {
                const div = document.createElement('div');
                div.className = 'seat available';
                div.id = `seat-${i}`;
                div.innerText = i;
                div.onclick = () => handleSeatSelection(div, i);
                container.appendChild(div);
            }
            
            // å¾ GAS è®€å–å·²ä½”ç”¨åº§ä½ (éœ€å¯¦ä½œ doGet)
            try {
                const res = await fetch(GAS_URL);
                occupiedSeats = await res.json();
                occupiedSeats.forEach(num => {
                    const el = document.getElementById(`seat-${num}`);
                    if(el) {
                        el.classList.replace('available', 'occupied');
                        el.onclick = null; // è®“å·²é è¨‚çš„ä½ç½®ä¸å¯é»é¸
                    }
                });
            } catch(e) { console.log("æš«ç„¡é ç´„è³‡æ–™"); }
        };

        function updateUI() {
            const t = parseInt(document.getElementById('ticket_qty').value) || 0;
            const b = parseInt(document.getElementById('bundle_qty').value) || 0;
            const ts = parseInt(document.getElementById('tshirt_qty').value) || 0;
            const j = parseInt(document.getElementById('jacket_qty').value) || 0;

            const total = (t * PRICES.ticket) + (b * PRICES.bundle) + (ts * PRICES.tshirt) + (j * PRICES.jacket);
            document.getElementById('total-display').innerText = total;
            document.getElementById('seat-hint').innerText = `è³¼ç¥¨ç¸½æ•¸ï¼š${t + b} å¼µï¼Œå·²é¸ï¼š${selectedSeats.length} ä½`;
        }

        function handleSeatSelection(div, num) {
            const limit = (parseInt(document.getElementById('ticket_qty').value) || 0) + 
                          (parseInt(document.getElementById('bundle_qty').value) || 0);
            
            if (div.classList.contains('selected')) {
                div.classList.remove('selected');
                selectedSeats = selectedSeats.filter(s => s !== num);
            } else {
                if (limit === 0) return alert("è«‹å…ˆé¸æ“‡è³¼ç¥¨å¼µæ•¸ï¼");
                if (selectedSeats.length >= limit) return alert(`è³¼è²· ${limit} å¼µç¥¨ï¼Œåªèƒ½é¸ ${limit} å€‹ä½å­ã€‚`);
                div.classList.add('selected');
                selectedSeats.push(num);
            }
            updateUI();
        }

        async function submitOrder() {async function submitOrder() {
    // å–å¾—é–€ç¥¨èˆ‡çµ„åˆåŒ…çš„ç¸½æ•¸ï¼Œé€™æ±ºå®šäº†å¯ä»¥é¸å¹¾å€‹ä½å­
    const tQty = parseInt(document.getElementById('ticket_qty').value) || 0;
    const bQty = parseInt(document.getElementById('bundle_qty').value) || 0;
    const limit = tQty + bQty; 

    const name = document.getElementById('name').value;
    const className = document.getElementById('class_name').value;

    // é˜²å‘†æª¢æŸ¥ï¼šå¿…é ˆå¡«å¯«å§“åã€ç­ç´šï¼Œä¸”åŠƒä½æ•¸é‡è¦å‰›å¥½ç­‰æ–¼è³¼ç¥¨å¼µæ•¸
    if (!name || !className) return alert("è«‹å¡«å¯«å§“åèˆ‡ç­ç´šï¼");
    if (selectedSeats.length !== limit) {
        return alert(`åŠƒä½æ•¸é‡ä¸ç¬¦ï¼\nä½ è³¼è²·äº† ${limit} å¼µç¥¨ï¼Œä½†ç›®å‰é¸äº† ${selectedSeats.length} å€‹ä½ç½®ã€‚`);
    }

    // é€™è£¡å°±æ˜¯ä½ å•çš„é‚£ä¸€è¡Œï¼Œç¢ºä¿æŠ“åˆ°ç•«é¢ä¸Šè¨ˆç®—å¥½çš„ç¸½é‡‘é¡
    const orderData = {
        name: name,
        class_name: className,
        phone: document.getElementById('phone').value,
        items: `ç¥¨:${tQty}, çµ„åˆ:${bQty}, T-A:${document.getElementById('tshirt_a_qty').value}`,
        seats: selectedSeats, // é€™æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä¾‹å¦‚ [1, 2]
        totalPrice: document.getElementById('total-display').innerText // æ­£ç¢ºï¼
    };

    try {
        // é€å‡ºè³‡æ–™åˆ°ä½ çš„ GAS ç¶²å€
        const response = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify(orderData) 
        });
        
        // å®Œæˆå¾Œé¡¯ç¤ºæ˜ç´°çµ¦åŒå­¸çœ‹
        const summary = `âœ¨ é è³¼æˆåŠŸï¼\nğŸ‘¤ å§“åï¼š${orderData.name}\nğŸ’º åŠƒä½ï¼š${selectedSeats.join(', ')}\nğŸ’° ç¸½é¡ï¼š$${orderData.totalPrice}\n\nğŸ“¢ é‡è¦ï¼šè«‹æ–¼ä¸€é€±å…§äº¤éŒ¢çµ¦ 2å¹´6ç­æ—ä½‘å®¶ï¼Œå¦å‰‡è¨»éŠ·ï¼`;
        alert(summary);
        
        // é‡æ–°æ•´ç†ç¶²é ï¼Œæ¸…ç©ºæš«å­˜
        location.reload();
    } catch (e) {
        alert('ç³»çµ±ç¹å¿™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡ï¼');
    }
}
