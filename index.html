<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M3 舞展預購系統</title>
    <style>
        :root { --available: #4CAF50; --occupied: #F44336; --selected: #FFEB3B; }
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        .item-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; border-radius: 5px; }
        .seat-map { display: grid; grid-template-columns: repeat(15, 1fr); gap: 5px; margin-top: 20px; overflow-x: auto; }
        .seat { width: 30px; height: 30px; border: 1px solid #ccc; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .available { background: var(--available); color: white; }
        .occupied { background: var(--occupied); cursor: not-allowed; color: white; }
        .selected { background: var(--selected); color: black; }
        .hidden { display: none; }
        .btn { background: #333; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>M3 舞展預購與劃位系統</h2>

    <div id="step-info">
        <h3>1. 個人資訊與品項</h3>
        <input type="text" id="userName" placeholder="姓名" required>
        <input type="text" id="userClass" placeholder="班級 (例：201)" required>
        
        <div id="products" style="margin-top:20px;">
            <div class="item-card">
                <span>門票 ($150)</span>
                <input type="number" class="prod-qty" data-name="門票" data-price="150" value="0" min="0">
            </div>
            <div class="item-card">
                <span>組合包 (門票+短袖) ($450)</span>
                <input type="number" class="prod-qty" data-name="組合包" data-price="450" data-is-bundle="true" value="0" min="0">
            </div>
            <div class="item-card">
                <span>外套 ($550)</span>
                <input type="number" class="prod-qty" data-name="外套" data-price="550" value="0" min="0">
            </div>
            </div>
        <button class="btn" onclick="goToSeats()">下一步：選擇座位</button>
    </div>

    <div id="step-seats" class="hidden">
        <h3>2. 劃位 (您可選擇 <span id="max-seats">0</span> 個位置)</h3>
        <p>前方為舞台方向</p>
        <div class="seat-map" id="seatContainer"></div>
        <button class="btn" onclick="submitOrder()">確認預購</button>
    </div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzYpwCDfy4madjQJ68OTCWtZ2wH29Ylbxxd6b48g9s2htDf5QeAJpK2_97DXfTmBjJA/exec"; // .../exec

  let selectedSeats = [];
  let maxSeatsAllowed = 0;
  let seatStatusMap = {}; // { "A1": "occupied" }

  // 先去後台拉座位狀態
  async function loadSeatStatus() {
    const url = `${GAS_URL}?action=seatStatus`;
    const res = await fetch(url, { method: "GET" });
    const json = await res.json();
    if (json.result !== "success") throw new Error(json.message || "loadSeatStatus failed");

    seatStatusMap = {};
    (json.seats || []).forEach(([id, status]) => {
      seatStatusMap[String(id)] = String(status);
    });
  }

  // 初始化座位 UI：根據 seatStatusMap 決定 occupied/available
  function initSeats() {
    const container = document.getElementById('seatContainer');
    container.innerHTML = ""; // 重要：避免重複渲染
    selectedSeats = [];       // 切頁重來避免殘留

    const rows = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    for (let r = 0; r < 10; r++) {
      for (let c = 1; c <= 15; c++) {
        const seatId = rows[r] + c;

        const div = document.createElement('div');
        div.className = 'seat';
        div.innerText = seatId;

        const status = seatStatusMap[seatId] || "available";
        if (status === "occupied") {
          div.classList.add("occupied");
          div.onclick = null; // 不可點
        } else {
          div.classList.add("available");
          div.onclick = () => toggleSeat(seatId, div);
        }

        container.appendChild(div);
      }
    }
  }

  async function goToSeats() {
    let ticketQty = 0;
    document.querySelectorAll('.prod-qty').forEach(input => {
      if (input.dataset.name === "門票") ticketQty += parseInt(input.value || "0", 10);
      if (input.dataset.isBundle) ticketQty += parseInt(input.value || "0", 10);
    });

    if (ticketQty <= 0) {
      alert("請至少購買一張門票或組合包才能劃位！");
      return;
    }

    maxSeatsAllowed = ticketQty;
    document.getElementById('max-seats').innerText = maxSeatsAllowed;
    document.getElementById('step-info').classList.add('hidden');
    document.getElementById('step-seats').classList.remove('hidden');

    try {
      await loadSeatStatus();
      initSeats();
    } catch (e) {
      alert("讀取座位狀態失敗：" + e.message);
    }
  }

  function toggleSeat(id, el) {
    if (el.classList.contains('occupied')) return;

    if (selectedSeats.includes(id)) {
      selectedSeats = selectedSeats.filter(s => s !== id);
      el.classList.remove('selected');
    } else {
      if (selectedSeats.length >= maxSeatsAllowed) {
        alert(`您購買了 ${maxSeatsAllowed} 張票，只能選 ${maxSeatsAllowed} 個位子`);
        return;
      }
      selectedSeats.push(id);
      el.classList.add('selected');
    }
  }

  // 送出訂單：真正 POST 到 GAS doPost
  async function submitOrder() {
    if (selectedSeats.length !== maxSeatsAllowed) {
      alert("請選滿對應數量的座位！");
      return;
    }

    const name = document.getElementById('userName').value.trim();
    const className = document.getElementById('userClass').value.trim();
    if (!name || !className) {
      alert("請填寫姓名與班級");
      return;
    }

    // 你原本寫 totalPrice/items 是假的，先至少組出 items
    const items = [];
    let totalPrice = 0;
    document.querySelectorAll('.prod-qty').forEach(input => {
      const qty = parseInt(input.value || "0", 10);
      if (qty > 0) {
        const price = parseInt(input.dataset.price || "0", 10);
        items.push({ name: input.dataset.name, qty, price });
        totalPrice += qty * price;
      }
    });

    const payload = {
      name,
      className,
      seats: selectedSeats,
      totalPrice,
      items
    };

    try {
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" }, 
        // GAS 常見相容做法：用 text/plain 傳 JSON 字串
        body: JSON.stringify(payload)
      });

      const json = await res.json();

      if (json.result === "success") {
        alert(`預購成功！\n座位：${selectedSeats.join(", ")}\n請於一週內付款，否則取消。`);
        // 成功後重新載入座位狀態，避免下一個人看到舊畫面
        await loadSeatStatus();
        initSeats();
      } else {
        // 若是搶位衝突，後台會回 conflict
        if (json.conflict && json.conflict.length) {
          alert(`這些座位已被搶先選走：${json.conflict.join(", ")}\n請重新選位。`);
          await loadSeatStatus();
          initSeats();
        } else {
          alert("送出失敗：" + (json.message || "unknown error"));
        }
      }
    } catch (e) {
      alert("送出失敗（網路或權限問題）：" + e.message);
    }
  }
</script>

</body>
</html>


