<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>M3 èˆå±•é è³¼ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --available: #2e7d32; --occupied: #bdbdbd; --selected: #FFEB3B; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f8f9fa; margin: 0; }
        .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        
        /* å•†å“å¡ç‰‡å„ªåŒ– */
        .item-card { border: 1px solid #eee; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; background: #fff; }
        .item-name { font-weight: bold; }
        
        /* åº§ä½è¡¨å„ªåŒ– */
        .seat-map { display: grid; grid-template-columns: repeat(15, 1fr); gap: 4px; margin-top: 20px; overflow-x: auto; padding-bottom: 10px; }
        .seat {
            width: 28px; height: 28px; border-radius: 4px; font-size: 9px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: transform 0.1s; user-select: none;
        }
        .seat:active { transform: scale(0.9); }
        .available { background: var(--available); color: white; }
        .occupied { background: var(--occupied); color: #666; cursor: not-allowed; pointer-events: none; }
        .selected { background: var(--selected); color: black; font-weight: bold; border: 1px solid #fbc02d; }
        
        .hidden { display: none !important; }
        .btn { 
            background: #212121; color: white; padding: 12px 20px; border: none; 
            cursor: pointer; margin-top: 20px; width: 100%; border-radius: 6px; font-size: 16px; 
        }
        .btn:active { background: #000; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100px; }
        #userName, #userClass { width: 100%; box-sizing: border-box; margin-bottom: 10px; padding: 10px; }

        /* --- Loading é®ç½©æ¨£å¼ (é—œéµ) --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); /* æ·±è‰²èƒŒæ™¯ */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999; color: white;
            backdrop-filter: blur(3px); /* æ¨¡ç³ŠèƒŒæ™¯æ•ˆæœ */
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid #FFEB3B; /* é»ƒè‰²è½‰åœˆ */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { font-size: 1.1em; letter-spacing: 1px; font-weight: 300; }
    </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <div id="loading-text">è³‡æ–™è®€å–ä¸­...</div>
</div>

<div class="container">
    <h2>ğŸ’ƒ M3 èˆå±•é è³¼ç³»çµ±</h2>

    <div id="step-info">
        <h3>1. å¡«å¯«è³‡æ–™èˆ‡é¸æ“‡å“é …</h3>
        <input type="text" id="userName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
        <input type="text" id="userClass" placeholder="ç­ç´š (ä¾‹ï¼š201)" required>
        
        <div id="products" style="margin-top:20px;">
            <div class="item-card">
                <span class="item-name">é–€ç¥¨ ($150)</span>
                <input type="number" class="prod-qty" data-name="é–€ç¥¨" data-price="150" value="0" min="0">
            </div>
            <div class="item-card">
                <span class="item-name">çµ„åˆåŒ… (é–€ç¥¨+çŸ­è¢–) ($450)</span>
                <input type="number" class="prod-qty" data-name="çµ„åˆåŒ…" data-price="450" value="0" min="0">
            </div>
            <div class="item-card">
                <span class="item-name">å¤–å¥— ($550)</span>
                <input type="number" class="prod-qty" data-name="å¤–å¥—" data-price="550" value="0" min="0">
            </div>
        </div>
        <button class="btn" onclick="goToSeats()">ä¸‹ä¸€æ­¥ï¼šé¸æ“‡åº§ä½</button>
    </div>

    <div id="step-seats" class="hidden">
        <h3>2. åŠƒä½ (éœ€é¸ <span id="max-seats">0</span> ä½)</h3>
        <div style="text-align: center; background: #eee; padding: 5px; margin-bottom: 10px; font-size: 12px; border-radius: 4px;">â¬†ï¸ å‰æ–¹èˆå° â¬†ï¸</div>
        <div class="seat-map" id="seatContainer"></div>
        <button class="btn" style="background: #2e7d32;" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
        <button class="btn" style="background: #757575; margin-top: 10px;" onclick="goBack()">å›ä¸Šä¸€æ­¥</button>
    </div>
</div>

<script>
// âš ï¸ è«‹æ›æˆä½ çš„ Google Apps Script ç¶²å€
const GAS_URL = "https://script.google.com/macros/s/AKfycbxKtz-Hxd8PZZt6L1iqADP5kjW22MkZAOlWDREBQYTmh4g8cYZuFu54i9ylwzSJsG-b/exec"; 

let selectedSeats = [];
let maxSeatsAllowed = 0;
let seatStatusMap = {}; 
let isDataPreloaded = false; // æ¨™è¨˜ï¼šè³‡æ–™æ˜¯å¦é è¼‰å®Œæˆ

                       // 1. ã€é å…ˆè¼‰å…¥ã€‘ç¶²é ä¸€æ‰“é–‹ï¼ŒèƒŒæ™¯å°±å·æŠ“è³‡æ–™
window.onload = function() {
    console.log("ğŸš€ ç³»çµ±å•Ÿå‹•ï¼Œé–‹å§‹é è¼‰åº§ä½...");
    fetch(`${GAS_URL}?action=seatStatus`)
        .then(res => res.json())
        .then(json => {
            if (json.result === "success") {
                updateLocalSeatData(json.seats);
                isDataPreloaded = true;
                console.log("âœ… åº§ä½è¡¨é è¼‰å®Œæˆï¼");
            }
        })
        .catch(err => console.log("é è¼‰å¤±æ•— (å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œï¼Œç¨å¾Œæœƒè‡ªå‹•é‡è©¦)"));
};

// è¼”åŠ©ï¼šæ›´æ–°æœ¬åœ°è®Šæ•¸
function updateLocalSeatData(seatsArray) {
    seatStatusMap = {};
    (seatsArray || []).forEach(([id, status]) => {
        seatStatusMap[String(id)] = String(status);
    });
}

// 2. æ¸²æŸ“åº§ä½
function initSeats() {
    const container = document.getElementById("seatContainer");
    container.innerHTML = "";
    selectedSeats = []; // é‡ç½®é¸æ“‡

    const rows = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    for (let r = 0; r < 10; r++) { // A-J æ’
        for (let c = 1; c <= 15; c++) {
            const seatId = rows[r] + c;
            const div = document.createElement("div");
            div.classList.add("seat");

            const status = seatStatusMap[seatId] || "available";
            if (status === "occupied") {
                div.classList.add("occupied");
            } else {
                div.classList.add("available");
                div.onclick = () => toggleSeat(seatId, div);
            }
            div.innerText = seatId;
            container.appendChild(div);
        }
    }
}

// 3. åˆ‡æ›åˆ°é¸ä½ç•«é¢
async function goToSeats() {
    const name = document.getElementById("userName").value.trim();
    const className = document.getElementById("userClass").value.trim();
    if (!name || !className) {
        Swal.fire({ icon: 'warning', title: 'è³‡æ–™æœªå¡«', text: 'è«‹è¼¸å…¥å§“åèˆ‡ç­ç´šï¼' });
        return;
    }

    let ticketQty = 0;
    document.querySelectorAll(".prod-qty").forEach(input => {
        const itemName = input.dataset.name;
        const qty = parseInt(input.value || "0", 10);
        if ((itemName === "é–€ç¥¨" || itemName === "çµ„åˆåŒ…") && qty > 0) {
            ticketQty += qty;
        }
    });

    if (ticketQty <= 0) {
        Swal.fire({ icon: 'info', title: 'å°šæœªè³¼ç¥¨', text: 'è«‹è‡³å°‘è³¼è²·ä¸€å¼µé–€ç¥¨æˆ–çµ„åˆåŒ…æ‰èƒ½åŠƒä½ï¼' });
        return;
    }

    maxSeatsAllowed = ticketQty;
    document.getElementById("max-seats").innerText = maxSeatsAllowed;

    // --- é—œéµå„ªåŒ–é‚è¼¯ ---
    if (isDataPreloaded) {
        // A. å¦‚æœè³‡æ–™å·²ç¶“é è¼‰å¥½ -> ç§’åˆ‡æ›
        initSeats();
        switchStep(2);
    } else {
        // B. å¦‚æœé‚„æ²’å¥½ -> é¡¯ç¤º Loading ç­‰è³‡æ–™
        showLoading("æ­£åœ¨è¼‰å…¥æœ€æ–°åº§ä½...");
        try {
            const res = await fetch(`${GAS_URL}?action=seatStatus`);
            const json = await res.json();
            if (json.result === "success") {
                updateLocalSeatData(json.seats);
                initSeats();
                switchStep(2);
            } else {
                throw new Error("Load failed");
            }
        } catch (e) {
            Swal.fire({ icon: 'error', title: 'é€£ç·šéŒ¯èª¤', text: 'è«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹å¾Œé‡è©¦' });
        } finally {
            hideLoading();
        }
    }
}

function switchStep(step) {
    if (step === 2) {
        document.getElementById("step-info").classList.add("hidden");
        document.getElementById("step-seats").classList.remove("hidden");
    } else {
        document.getElementById("step-info").classList.remove("hidden");
        document.getElementById("step-seats").classList.add("hidden");
    }
}

function goBack() {
    switchStep(1);
}

// 4. é¸ä½é‚è¼¯
function toggleSeat(id, el) {
    if (el.classList.contains("occupied")) return;

    if (selectedSeats.includes(id)) {
        selectedSeats = selectedSeats.filter(s => s !== id);
        el.classList.remove("selected");
    } else {
        if (selectedSeats.length >= maxSeatsAllowed) {
            // ä½¿ç”¨ SweetAlert çš„ Toast æ¨¡å¼ï¼Œæ¯”è¼ƒä¸å¹²æ“¾
            Swal.fire({
                toast: true, position: 'top-end', icon: 'warning', 
                title: `åªèƒ½é¸ ${maxSeatsAllowed} å€‹ä½å­`, showConfirmButton: false, timer: 1500
            });
            return;
        }
        selectedSeats.push(id);
        el.classList.add("selected");
    }
}

// 5. é€å‡ºè¨‚å–®
async function submitOrder() {
    if (selectedSeats.length !== maxSeatsAllowed) {
        Swal.fire({ icon: 'warning', title: 'åº§ä½æœªé¸æ»¿', text: `éœ€é¸ ${maxSeatsAllowed} å€‹ï¼Œç›®å‰å·²é¸ ${selectedSeats.length} å€‹ã€‚` });
        return;
    }

    const items = [];
    let totalPrice = 0;
    document.querySelectorAll(".prod-qty").forEach(input => {
        const qty = parseInt(input.value || "0", 10);
        if (qty > 0) {
            const price = parseInt(input.dataset.price, 10);
            items.push({ name: input.dataset.name, qty, price });
            totalPrice += qty * price;
        }
    });

    const payload = {
        name: document.getElementById("userName").value.trim(),
        className: document.getElementById("userClass").value.trim(),
        seats: selectedSeats,
        items,
        totalPrice
    };

    // --- Loading é®ç½©é–‹å•Ÿ ---
    showLoading("æ­£åœ¨æ¶ä½ä¸­ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...");

    try {
        const res = await fetch(GAS_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        });
        const json = await res.json();
        
        hideLoading(); // é—œé–‰é®ç½©

        if (json.result === "success") {
            // --- è£½ä½œå•†å“æ˜ç´°åˆ—è¡¨ HTML ---
            const itemsHtml = items.map(it => 
                `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span>${it.name} x${it.qty}</span>
                    <span>$${it.qty * it.price}</span>
                 </div>`
            ).join("");

            // --- é¡¯ç¤ºè©³ç´°çš„ SweetAlert æˆåŠŸç•«é¢ ---
            Swal.fire({
                icon: 'success',
                title: 'ğŸ‰ é è³¼æˆåŠŸï¼',
                width: 480, // åŠ å¯¬è¦–çª—ä»¥ä¾¿é¡¯ç¤ºæ˜ç´°
                html: `
                    <div style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 15px; color: #333;">
                        <p style="margin: 5px 0;"><b>ğŸ§‘â€ğŸ“ å§“åï¼š</b>${payload.name}</p>
                        <p style="margin: 5px 0;"><b>ğŸ« ç­ç´šï¼š</b>${payload.className}</p>
                        <p style="margin: 5px 0;"><b>ğŸª‘ åº§ä½ä»£è™Ÿï¼š</b><span style="color:#2e7d32; font-weight:bold;">${selectedSeats.join(", ")}</span></p>
                        
                        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
                        
                        <div style="font-size: 14px; margin-bottom: 10px;">
                            <b>ğŸ§¾ å•†å“æ˜ç´°ï¼š</b><br>
                            ${itemsHtml}
                        </div>
                        
                        <hr style="border: 0; border-top: 2px solid #333; margin: 10px 0;">
                        
                        <div style="text-align: right; font-size: 18px; font-weight: bold;">
                            ç¸½é‡‘é¡ï¼š<span style="color: #d32f2f;">$${totalPrice}</span>
                        </div>
                    </div>
                    
                    <div style="background-color: #ffebee; border: 1px solid #ef9a9a; padding: 12px; border-radius: 6px; color: #c62828; font-weight: bold; font-size: 15px; margin-top: 15px; line-height: 1.5;">
                        âš ï¸ é‡è¦ç¹³è²»é ˆçŸ¥<br>
                        è«‹æ–¼ä¸€é€±å…§å°‡æ¬¾é …äº¤çµ¦<br>
                        <span style="font-size: 1.2em; text-decoration: underline;">206 æ—ä½‘å®¶</span><br>
                        å¦å‰‡é å®šå•†å“åŠåŠƒä½å°‡å¤±æ•ˆï¼
                    </div>
                    
                    <div style="margin-top: 15px; color: #555; font-size: 13px;">
                        ğŸ“¸ è«‹æˆªåœ–æ­¤ç•«é¢ä½œç‚ºæ†‘è­‰
                    </div>
                `,
                confirmButtonText: 'å¥½ï¼Œæˆ‘æˆªåœ–äº†',
                confirmButtonColor: '#2e7d32',
                allowOutsideClick: false // å¼·åˆ¶ä¸èƒ½é»æ—é‚Šé—œé–‰
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload(); // æŒ‰ä¸‹ç¢ºå®šå¾Œé‡æ•´
                }
            });
        } else {
            // è™•ç†è¡çªéŒ¯èª¤
            if (json.conflict) {
                Swal.fire({
                    icon: 'error',
                    title: 'æ…¢äº†ä¸€æ­¥ ğŸ˜±',
                    text: `ä»¥ä¸‹åº§ä½å‰›è¢«æ¶èµ°ï¼š${json.conflict.join(", ")}ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚`
                });
                // é‡æ–°æ•´ç†åº§ä½
                showLoading("æ›´æ–°åº§ä½è¡¨ä¸­...");
                await fetch(`${GAS_URL}?action=seatStatus`)
                    .then(r => r.json())
                    .then(d => {
                        updateLocalSeatData(d.seats);
                        initSeats();
                    });
                hideLoading();
            } else {
                Swal.fire({ icon: 'error', title: 'ç³»çµ±éŒ¯èª¤', text: json.message });
            }
        }
    } catch (e) {
        hideLoading();
        console.error(e);
        Swal.fire({ icon: 'error', title: 'é€å‡ºå¤±æ•—', text: 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯' });
    }
}

// Loading UI æ§åˆ¶
function showLoading(text) {
    document.getElementById("loading-text").innerText = text;
    document.getElementById("loading-overlay").classList.remove("hidden");
}
function hideLoading() {
    document.getElementById("loading-overlay").classList.add("hidden");
}
</script>

</body>
</html>





