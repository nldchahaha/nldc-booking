<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M3 èˆå±•é è³¼ç³»çµ±</title>
   <style>
  :root {
    --available: #2e7d32;   /* ç¶  */
    --occupied: #9e9e9e;    /* ç° */
    --selected: #FFEB3B;    /* é»ƒ */
  }

  body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
  .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
  .item-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; border-radius: 5px; }
  .seat-map { display: grid; grid-template-columns: repeat(15, 1fr); gap: 5px; margin-top: 20px; overflow-x: auto; }

  .seat {
    width: 30px; height: 30px; border: 1px solid #ccc;
    font-size: 10px; display: flex; align-items: center; justify-content: center;
    cursor: pointer;
  }

  .available { background: var(--available); color: white; }
  .occupied  { background: var(--occupied); color: #333; cursor: not-allowed; opacity: 0.8; pointer-events: none; }
  .selected  { background: var(--selected); color: black; }

  .hidden { display: none; }
  .btn { background: #333; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 20px; }
</style>

</head>
<body>

<div class="container">
    <h2>M3 èˆå±•é è³¼èˆ‡åŠƒä½ç³»çµ±</h2>

    <div id="step-info">
        <h3>1. å€‹äººè³‡è¨Šèˆ‡å“é …</h3>
        <input type="text" id="userName" placeholder="å§“å" required>
        <input type="text" id="userClass" placeholder="ç­ç´š (ä¾‹ï¼š201)" required>
        
        <div id="products" style="margin-top:20px;">
            <div class="item-card">
                <span>é–€ç¥¨ ($150)</span>
                <input type="number" class="prod-qty" data-name="é–€ç¥¨" data-price="150" value="0" min="0">
            </div>
            <div class="item-card">
                <span>çµ„åˆåŒ… (é–€ç¥¨+çŸ­è¢–) ($450)</span>
                <input type="number" class="prod-qty" data-name="çµ„åˆåŒ…" data-price="450" data-is-bundle="true" value="0" min="0">
            </div>
            <div class="item-card">
                <span>å¤–å¥— ($550)</span>
                <input type="number" class="prod-qty" data-name="å¤–å¥—" data-price="550" value="0" min="0">
            </div>
            </div>
        <button class="btn" onclick="goToSeats()">ä¸‹ä¸€æ­¥ï¼šé¸æ“‡åº§ä½</button>
    </div>

    <div id="step-seats" class="hidden">
        <h3>2. åŠƒä½ (æ‚¨å¯é¸æ“‡ <span id="max-seats">0</span> å€‹ä½ç½®)</h3>
        <p>å‰æ–¹ç‚ºèˆå°æ–¹å‘</p>
        <div class="seat-map" id="seatContainer"></div>
        <button class="btn" onclick="submitOrder()">ç¢ºèªé è³¼</button>
    </div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyfedKAJFr26zRZC1taZKZU3zG5CL_75jCXrhixsPCMB7DG5hbZsYK-igbHDPXHqBTt/exec"; 

let selectedSeats = [];
let maxSeatsAllowed = 0;
let seatStatusMap = {}; 

// 1. è®€å–åº§ä½ç‹€æ…‹
async function loadSeatStatus() {
  const res = await fetch(`${GAS_URL}?action=seatStatus`, { method: "GET" });
  const json = await res.json();
  if (json.result !== "success") throw new Error(json.message || "loadSeatStatus failed");
  seatStatusMap = {};
  (json.seats || []).forEach(([id, status]) => {
    seatStatusMap[String(id)] = String(status);
  });
}

// 2. æ¸²æŸ“åº§ä½è¡¨
function initSeats() {
  const container = document.getElementById("seatContainer");
  container.innerHTML = "";
  selectedSeats = [];

  const rows = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  for (let r = 0; r < 10; r++) { // å‡è¨­æ’åˆ° J æ’
    for (let c = 1; c <= 15; c++) {
      const seatId = rows[r] + c;
      const div = document.createElement("div");
      div.classList.add("seat");

      const status = seatStatusMap[seatId] || "available";

      if (status === "occupied") {
        div.classList.add("occupied");     
        div.style.pointerEvents = "none";  
      } else {
        div.classList.add("available");    
        div.onclick = () => toggleSeat(seatId, div);
      }

      div.innerText = seatId;
      container.appendChild(div);
    }
  }
}

// 3. ã€ä¿®å¾©ã€‘é€²å…¥é¸ä½ç•«é¢ï¼ˆä¸‹ä¸€æ­¥ï¼‰
async function goToSeats() {
  // å…ˆæª¢æŸ¥å§“åèˆ‡ç­ç´šæœ‰æ²’æœ‰å¡«
  const name = document.getElementById("userName").value.trim();
  const className = document.getElementById("userClass").value.trim();
  if (!name || !className) {
    alert("è«‹å…ˆå¡«å¯«å§“åèˆ‡ç­ç´šï¼");
    return;
  }

  // å³æ™‚è¨ˆç®—é–€ç¥¨èˆ‡çµ„åˆåŒ…æ•¸é‡
  let ticketQty = 0;
  document.querySelectorAll(".prod-qty").forEach(input => {
    const itemName = input.dataset.name;
    const qty = parseInt(input.value || "0", 10);
    if ((itemName === "é–€ç¥¨" || itemName === "çµ„åˆåŒ…") && qty > 0) {
      ticketQty += qty;
    }
  });

  if (ticketQty <= 0) {
    alert("è«‹è‡³å°‘è³¼è²·ä¸€å¼µé–€ç¥¨æˆ–çµ„åˆåŒ…æ‰èƒ½åŠƒä½ï¼");
    return;
  }

  // è¨­å®šå¯ä»¥åŠƒä½çš„æ•¸é‡
  maxSeatsAllowed = ticketQty;
  document.getElementById("max-seats").innerText = maxSeatsAllowed;

  // åˆ‡æ›ç•«é¢
  document.getElementById("step-info").classList.add("hidden");
  document.getElementById("step-seats").classList.remove("hidden");

  // æŠ“å–ç‹€æ…‹ä¸¦æ¸²æŸ“åº§ä½
  try {
    await loadSeatStatus();
    initSeats();
  } catch (e) {
    alert("è¼‰å…¥åº§ä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹");
    console.error(e);
  }
}

// 4. ã€ä¿®å¾©ã€‘é»æ“Šåº§ä½é‚è¼¯
function toggleSeat(id, el) {
  if (el.classList.contains("occupied")) return;

  if (selectedSeats.includes(id)) {
    // å–æ¶ˆé¸å–
    selectedSeats = selectedSeats.filter(s => s !== id);
    el.classList.remove("selected");
  } else {
    // å¢åŠ é¸å–
    if (selectedSeats.length >= maxSeatsAllowed) {
      alert(`æ‚¨è³¼è²·äº† ${maxSeatsAllowed} å¼µç¥¨ï¼Œåªèƒ½é¸ ${maxSeatsAllowed} å€‹ä½å­`);
      return;
    }
    selectedSeats.push(id);
    el.classList.add("selected");
  }
}

// 5. ã€ä¿®å¾©ã€‘é€å‡ºè¨‚å–®
async function submitOrder() {
  const name = document.getElementById("userName").value.trim();
  const className = document.getElementById("userClass").value.trim();

  // æª¢æŸ¥é¸ä½æ•¸é‡æ˜¯å¦ç¬¦åˆ
  if (selectedSeats.length !== maxSeatsAllowed) {
    alert(`è«‹é¸æ»¿ ${maxSeatsAllowed} å€‹åº§ä½ï¼Œç›®å‰å·²é¸ ${selectedSeats.length} å€‹ã€‚`);
    return;
  }

  // å–å¾—å•†å“æ¸…å–®èˆ‡ç¸½é‡‘é¡
  const items = [];
  let totalPrice = 0;
  document.querySelectorAll(".prod-qty").forEach(input => {
    const qty = parseInt(input.value || "0", 10);
    if (qty > 0) {
      const itemName = input.dataset.name;
      const price = parseInt(input.dataset.price || "0", 10);
      items.push({ name: itemName, qty, price });
      totalPrice += qty * price;
    }
  });

  const payload = {
    name,
    className,
    seats: selectedSeats,
    items,
    totalPrice
  };

  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (json.result === "success") {
      const itemText = items.map(it => `${it.name} x${it.qty}`).join("ã€");
      
      // ä¿®å¾©ï¼šæ­£ç¢ºä½¿ç”¨åå¼•è™Ÿ (Template Literals) ä¾†é¡¯ç¤ºæ›è¡Œå½ˆçª—
      alert(`ğŸ‰ é è³¼æˆåŠŸï¼\n\nåº§ä½ï¼š${selectedSeats.join(", ")}\nå“é …ï¼š${itemText}\nç¸½é‡‘é¡ï¼š$${totalPrice}\n\nâš ï¸ é‡è¦è³‡è¨Šï¼šè«‹æ–¼ä¸€é€±å…§å°‡ç¾é‡‘äº¤çµ¦206æ—ä½‘å®¶ï¼Œå¦å‰‡é è³¼é …ç›®æœƒè¨»éŠ·ã€‚`);

      // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥é é¢ï¼Œæ¸…ç©ºè¡¨å–®
      location.reload();
      
    } else {
      if (json.conflict && json.conflict.length) {
        alert(`æ‰‹è…³æ…¢äº†ä¸€æ­¥ï¼Œé€™äº›åº§ä½å·²è¢«æ¶èµ°ï¼š${json.conflict.join(", ")}\nè«‹é‡æ–°é¸ä½ã€‚`);
        await loadSeatStatus();
        initSeats();
      } else {
        alert("é€å‡ºå¤±æ•—ï¼š" + (json.message || "unknown error"));
      }
    }
  } catch (e) {
    alert("é€å‡ºå¤±æ•—ï¼ˆç¶²è·¯æˆ–æ¬Šé™å•é¡Œï¼‰ï¼š" + e.message);
  }
}
</script>

</body>
</html>






