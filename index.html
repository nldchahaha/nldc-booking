<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M3 舞展預購系統</title>
   <style>
  :root {
    --available: #2e7d32;   /* 綠 */
    --occupied: #9e9e9e;    /* 灰 */
    --selected: #FFEB3B;    /* 黃 */
  }

  body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
  .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
  .item-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; border-radius: 5px; }
  .seat-map { display: grid; grid-template-columns: repeat(15, 1fr); gap: 5px; margin-top: 20px; overflow-x: auto; }

  .seat {
    width: 30px; height: 30px; border: 1px solid #ccc;
    font-size: 10px; display: flex; align-items: center; justify-content: center;
    cursor: pointer;
  }

  .available { background: var(--available); color: white; }
  .occupied  { background: var(--occupied); color: #333; cursor: not-allowed; opacity: 0.8; pointer-events: none; }
  .selected  { background: var(--selected); color: black; }

  .hidden { display: none; }
  .btn { background: #333; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 20px; }
</style>

</head>
<body>

<div class="container">
    <h2>M3 舞展預購與劃位系統</h2>

    <div id="step-info">
        <h3>1. 個人資訊與品項</h3>
        <input type="text" id="userName" placeholder="姓名" required>
        <input type="text" id="userClass" placeholder="班級 (例：201)" required>
        
        <div id="products" style="margin-top:20px;">
            <div class="item-card">
                <span>門票 ($150)</span>
                <input type="number" class="prod-qty" data-name="門票" data-price="150" value="0" min="0">
            </div>
            <div class="item-card">
                <span>組合包 (門票+短袖) ($450)</span>
                <input type="number" class="prod-qty" data-name="組合包" data-price="450" data-is-bundle="true" value="0" min="0">
            </div>
            <div class="item-card">
                <span>外套 ($550)</span>
                <input type="number" class="prod-qty" data-name="外套" data-price="550" value="0" min="0">
            </div>
            </div>
        <button class="btn" onclick="goToSeats()">下一步：選擇座位</button>
    </div>

    <div id="step-seats" class="hidden">
        <h3>2. 劃位 (您可選擇 <span id="max-seats">0</span> 個位置)</h3>
        <p>前方為舞台方向</p>
        <div class="seat-map" id="seatContainer"></div>
        <button class="btn" onclick="submitOrder()">確認預購</button>
    </div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzGTEkK--tzxjAb1BpYraWHU_Z-HXLqv2EWATUoPqU7lFvE_d8w5ll8tvADkR7SkHGZ/exec"; 

  let selectedSeats = [];
  let maxSeatsAllowed = 0;
  let seatStatusMap = {}; // { "A1": "occupied" | "available" }

  async function loadSeatStatus() {
    const res = await fetch(`${GAS_URL}?action=seatStatus`, { method: "GET" });
    const json = await res.json();
    if (json.result !== "success") throw new Error(json.message || "loadSeatStatus failed");
    seatStatusMap = {};
    (json.seats || []).forEach(([id, status]) => {
      seatStatusMap[String(id)] = String(status);
    });
  }

  function initSeats() {
    const container = document.getElementById("seatContainer");
    container.innerHTML = "";
    selectedSeats = [];

    const rows = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    for (let r = 0; r < 10; r++) {
      for (let c = 1; c <= 15; c++) {
        const seatId = rows[r] + c;

        const div = document.createElement("div");
        div.classList.add("seat");

        const status = seatStatusMap[seatId] || "available";

        if (status === "occupied") {
          div.classList.add("occupied");     // 灰色
          div.style.pointerEvents = "none";  // 直接禁用點擊（最保險）
        } else {
          div.classList.add("available");    // 綠色
          div.onclick = () => toggleSeat(seatId, div);
        }

        div.innerText = seatId;
        container.appendChild(div);
      }
    }
  }

  async function goToSeats() {
    let ticketQty = 0;
    document.querySelectorAll(".prod-qty").forEach(input => {
      if (input.dataset.name === "門票") ticketQty += parseInt(input.value || "0", 10);
      if (input.dataset.isBundle) ticketQty += parseInt(input.value || "0", 10);
    });

    if (ticketQty <= 0) {
      alert("請至少購買一張門票或組合包才能劃位！");
      return;
    }

    maxSeatsAllowed = ticketQty;
    document.getElementById("max-seats").innerText = maxSeatsAllowed;

    document.getElementById("step-info").classList.add("hidden");
    document.getElementById("step-seats").classList.remove("hidden");

    // ✅ 先抓座位狀態，再渲染座位
    await loadSeatStatus();
    initSeats();
  }

  function toggleSeat(id, el) {
    if (el.classList.contains("occupied")) return;

    if (selectedSeats.includes(id)) {
      selectedSeats = selectedSeats.filter(s => s !== id);
      el.classList.remove("selected");
    } else {
      if (selectedSeats.length >= maxSeatsAllowed) {
        alert(`您購買了 ${maxSeatsAllowed} 張票，只能選 ${maxSeatsAllowed} 個位子`);
        return;
      }
      selectedSeats.push(id);
      el.classList.add("selected");
    }
  }
</script>

</body>
</html>



